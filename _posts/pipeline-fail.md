---
title: Gitlab-CIä¸­æœ‰å…³JOBå¤±è´¥çš„ç›¸å…³é…ç½®
date: 2018-10-11 15:27:19
tags:
---

è¿˜æ˜¯å®ä¹ çš„æ—¶å€™æ‰“çš„æ‚ğŸŒš

<!-- more -->

çœ‹äº†ä¸€ä¸‹gitlabå®˜ç½‘ä¸Šæœ‰å…³ciçš„ç›¸å…³æ–‡æ¡£ï¼Œç„¶åæ‰¾åˆ°äº†ä¸€äº›å¯ä»¥ç”¨çš„ä¸œè¥¿ï¼Œå¹¶ä¸”åœ¨å…¬å¸çš„gitlabä¸Šå»ºäº†å‡ ä¸ªrepoåšäº†ä¸€äº›å®éªŒç„¶åå°†æœ‰ç”¨çš„å†…å®¹æ€»ç»“äº†ä¸€ä¸‹

allow_failure
---

* ä½¿ç”¨`allow_failure: true `æ¥å…è®¸JOBå¤±è´¥è€Œä¸å½±å“CIä¸­çš„å…¶ä»–çš„éƒ¨åˆ†
* è¢«`allow_failure: true`æ ‡è®°çš„JOBå¦‚æœfailï¼Œé‚£ä¹ˆå°†åœ¨pipelineä¸­ä»¥é»„è‰²æ„Ÿå¹å·æ ‡è¯†
* **ç»è¿‡å®éªŒï¼Œå¦‚æœå…ˆå‰stageä¸­çš„æŸäº›å¸¦æœ‰`allow_failure`çš„JOBå¤±è´¥äº†ï¼Œé‚£ä¹ˆå°†ä¸è§¦å‘åç»­stageä¸­çš„`when: on_failure`**


```yaml
job1:
  stage: test
  script:
    - execute_script_that_will_fail
  allow_failure: true
```

when
---

* å¯ä»¥æ˜¯`on_success`ï¼Œ`on_failure`ï¼Œ`always`ï¼Œ`manual`ä¸­çš„ä¸€ä¸ª
* è§„å®šä»€ä¹ˆæ—¶å€™æ‰§è¡ŒJOBçš„æ—¶æœºï¼ˆä¸Šé¢å‡ ä¸ªé€‰é¡¹çš„å­—é¢æ„æ€ï¼‰
* é»˜è®¤çš„å€¼æ˜¯`when: on_success`
* å½“ä¸€ä¸ªJOBä¸­å«æœ‰`when: on_failure`ï¼Œé‚£ä¹ˆè¿™ä¸ªJOBå½“ä¸”ä»…å½“å…ˆå‰é˜¶æ®µï¼ˆstageï¼‰çš„JOBå¤±è´¥çš„æ—¶å€™ï¼Œå½“å‰çš„JOBæ‰æ‰§è¡Œï¼Œè¯¥JOBåç»­stageä¸­å«æœ‰`when: on_success`ä¸æ‰§è¡Œï¼ˆå› ä¸ºå‰é¢æœ‰JOBå¤±è´¥äº†ï¼‰
* å½“ä¸€ä¸ªJOBä¸­å«æœ‰`when: manual`ï¼Œé‚£ä¹ˆè¿™ä¸ªJOBå°†ä¸ä¼šæ‰§è¡Œï¼ˆç­‰å¾…æ‰‹åŠ¨æ‰§è¡Œï¼‰ï¼Œåç»­stageä¸­çš„JOBå°†ç…§å¸¸æ‰§è¡Œ

```yaml
cleanup_build_job:
  stage: cleanup_build
  script:
    - cleanup build when failed
  when: on_failure
```

artifacts:when
---

* ç”¨äºè®¾ç½®ä½•æ—¶ä¸Šä¼ artifactsï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆç”¨

retry
---

* åœ¨Gitlab 9.5ä¹‹ååŠ å…¥
* è®¾ç½®JOBå¤±è´¥ä¹‹åé‡è¯•çš„æ¬¡æ•°
* `retry`å­—æ®µå¿…é¡»å¤§äºç­‰äº0ï¼Œå°äºç­‰äº2ï¼ˆä¹Ÿå°±æ˜¯æ€»å…±æœ€å¤šæ‰§è¡Œ3æ¬¡JOBï¼‰

å¯èƒ½æ²¡æœ‰ä»€ä¹ˆç”¨çš„æŠ€å·§å’Œç»“è®º
---

* åœ¨CI/CDä¸­çš„pipelienä¸­çš„å³ä¸Šè§’å¯ä»¥å¥½åˆ°ci lintï¼Œå¯ä»¥ç”¨æ¥éªŒè¯.gitlab-ci.ymlæ˜¯å¦ç¬¦åˆåŸºæœ¬æ³•ï¼ˆæ ¼å¼è¦æ±‚ï¼‰
* gitlabä¼šå°†åç§°ç›¸ä¼¼çš„JOBæ”¾åˆ°åŒä¸€ä¸ªç»„ä¸­(å…·ä½“æ“ä½œä»¶[ç›¸å…³å‚è€ƒèµ„æ–™](https://docs.gitlab.com/ee/ci/pipelines.html#grouping-similar-jobs-in-the-pipeline-graph))
* å³ä½¿JOBæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¹Ÿä¼šå› ä¸ºæŸäº›ç„å­¦åŸå› å¤±è´¥ï¼Œå› æ­¤è®¤ä¸ºè®¾ç½®`retry`æ˜¯éå¸¸æœ‰å¿…è¦çš„